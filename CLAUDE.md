# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

This is the **PSD Claude Coding System** - a unified Claude Code plugin for Peninsula School District combining:

1. **Workflow Automation** (Stable) - 9 battle-tested commands + 10 workflow specialist agents
2. **Meta-Learning System** (Experimental) - 9 commands + 5 meta-learning agents that learn from usage

**Version**: 1.1.2
**Status**: âœ… Production-Ready Workflows + ðŸ§ª Experimental Meta-Learning

## Architecture

### Unified Plugin Structure

The plugin follows Claude Code's architecture with automatic telemetry via hooks:
```
plugins/psd-claude-coding-system/
  â”œâ”€â”€ .claude-plugin/
  â”‚   â””â”€â”€ plugin.json          # Plugin metadata (v1.1.0)
  â”œâ”€â”€ commands/                 # 18 slash commands (*.md)
  â”œâ”€â”€ agents/                   # 15 specialized AI agents (*.md)
  â”œâ”€â”€ hooks/
  â”‚   â””â”€â”€ hooks.json            # Automatic telemetry collection
  â”œâ”€â”€ scripts/
  â”‚   â”œâ”€â”€ telemetry-init.sh     # SessionStart hook
  â”‚   â”œâ”€â”€ telemetry-command.sh  # UserPromptSubmit hook
  â”‚   â”œâ”€â”€ telemetry-agent.sh    # SubagentStop hook
  â”‚   â””â”€â”€ telemetry-track.sh    # Stop hook
  â”œâ”€â”€ meta/                     # Telemetry data (git-ignored)
  â””â”€â”€ README.md                 # Plugin documentation
```

### Command vs Agent Pattern

**Commands** are user-facing workflows invoked with `/command-name`:
- Contain YAML frontmatter defining allowed-tools, model, extended-thinking
- Include bash scripts and structured workflows
- May invoke agents via the Task tool for specialized work

**Agents** are specialized AI assistants invoked by commands or other Claude Code instances:
- Contain YAML frontmatter with name, description, model, color
- Focused on specific domains (backend, frontend, security, testing, etc.)
- Run autonomously with specific tool access

### Workflow Commands (9 commands)

Production-ready workflows all using latest Claude models (sonnet-4-5, opus-4-1) with extended-thinking enabled.

**Command Workflow Pattern**: Most commands follow this structure:
1. **Phase 1**: Context gathering (git status, issue details, file analysis)
2. **Phase 2**: Setup (branch creation, dependency checks)
3. **Phase 3**: Implementation (may invoke specialized agents)
4. **Phase 4**: Validation (tests, commits, PRs)

**Key Commands**:
- `/work [issue-number|description]` - Main implementation workflow, auto-detects issue vs quick-fix mode
- `/architect [issue-number|topic]` - Architecture design using opus-4-1 for deep reasoning
- `/test [scope]` - Comprehensive testing with coverage validation
- `/review_pr [number]` - Systematic PR feedback handling
- `/compound_concepts` - Finds automation/systematization opportunities
- `/security_audit` - Security review and vulnerability analysis
- `/issue [description]` - Research and create structured GitHub issues
- `/product-manager [idea]` - Transform ideas into product specs
- `/clean_branch` - Post-merge cleanup

**Workflow Agents** (10 total):
- Domain specialists: backend-specialist, frontend-specialist, database-specialist, llm-specialist
- Quality/security: test-specialist, security-analyst, performance-optimizer
- Documentation/planning: documentation-writer, plan-validator, gpt-5

**Meta-Learning Agents** (5 total):
- meta-orchestrator, code-cleanup-specialist, pr-review-responder, document-validator, breaking-change-validator

### Meta-Learning Commands (9 commands)

Experimental self-improving system with telemetry-based learning.

**Architecture Principle**: Observes â†’ Learns â†’ Suggests â†’ Implements â†’ Evolves â†’ Predicts

**Data Storage**: All telemetry stored in `plugins/psd-claude-coding-system/meta/*.json` (git-ignored)
- `telemetry.json` - Command execution logs (auto-generated by hooks)
- `experiments.json` - A/B test results
- `compound_history.json` - Improvement history
- `workflow_graph.json` - Agent workflow patterns
- `agent_variants.json` - Genetic algorithm variants

**Key Commands**:
- `/meta_analyze` - Pattern extraction from telemetry
- `/meta_learn` - Generate improvement suggestions
- `/meta_implement` - Auto-apply improvements (with dry-run)
- `/meta_evolve` - Genetic algorithm for agent improvement

### Telemetry Integration Architecture (NEW in v1.1.0)

**Hook-Based Automatic Telemetry** - Zero AI involvement, 100% reliable:

1. **SessionStart Hook** (`scripts/telemetry-init.sh`):
   - Runs when Claude Code session starts
   - Creates `meta/telemetry.json` if it doesn't exist
   - No output, silent initialization

2. **UserPromptSubmit Hook** (`scripts/telemetry-command.sh`):
   - Runs when user submits a prompt
   - Detects slash command execution (e.g., `/work`, `/test`, `/meta_analyze`)
   - Creates session state file in `meta/.session_state_{SESSION_ID}`
   - Records: command name, arguments, start time

3. **SubagentStop Hook** (`scripts/telemetry-agent.sh`):
   - Runs when a Task tool (agent) completes
   - Appends agent name to session state file
   - Tracks which agents were invoked during command execution

4. **Stop Hook** (`scripts/telemetry-track.sh`):
   - Runs when Claude finishes responding
   - Reads session state file
   - Calculates duration
   - Uses `jq` to UPSERT entry into `meta/telemetry.json`
   - Cleans up session state file

**Data Flow** (completely automatic):
```
User runs: /work 347
  â”œâ”€> UserPromptSubmit hook: Create session state
  â”œâ”€> Claude executes command workflow
  â”‚    â”œâ”€> Invokes backend-specialist
  â”‚    â”‚    â””â”€> SubagentStop hook: Add "backend-specialist" to session
  â”‚    â””â”€> Invokes test-specialist
  â”‚         â””â”€> SubagentStop hook: Add "test-specialist" to session
  â”œâ”€> Claude finishes responding
  â””â”€> Stop hook: Finalize and write to telemetry.json
```

**Key Advantages**:
- **Reliable**: Hooks always execute (no AI involvement)
- **Zero Config**: Works automatically on plugin install
- **Privacy-Safe**: Only metadata collected, never code content
- **Graceful**: Uses `jq` if available, degrades gracefully if not
- **Local Only**: All data stays in git-ignored `meta/` folder

**Privacy Safeguards**:
- All data stored locally in git-ignored `meta/` folder
- Only metadata collected (never code, issues, commits, personal info)
- User can opt-out by disabling hooks or removing plugin
- No external network requests

## Marketplace Structure & Critical Files

### marketplace.json (CRITICAL)

Located at `.claude-plugin/marketplace.json`, this file is **essential** for Claude Code to discover plugins.

**Structure:**
```json
{
  "name": "psd-claude-coding-system",
  "owner": { "name": "...", "email": "..." },
  "metadata": {
    "description": "...",
    "version": "1.1.0",
    "pluginRoot": "./plugins"
  },
  "plugins": [
    {
      "name": "psd-claude-coding-system",
      "source": "./plugins/psd-claude-coding-system",
      "description": "...",
      "version": "1.1.0",
      "category": "productivity",
      "keywords": [...]
    }
  ]
}
```

**CRITICAL RULES:**

1. **plugins[] must match actual directory structure**
   - If you rename/merge plugins, update marketplace.json immediately
   - Each entry's `source` must point to an existing plugin directory
   - Version numbers should match plugin.json in each plugin

2. **Common mistake:** Deleting plugin directories but not updating marketplace.json
   - Symptom: "Plugin not found in any marketplace" error
   - Fix: Remove stale entries from `plugins[]` array

3. **When changing plugin structure:**
   - âœ… Update marketplace.json FIRST
   - âœ… Commit and push to GitHub
   - âœ… Force refresh in Claude Code: `cd ~/.claude/plugins/marketplaces/[name] && git pull`
   - âœ… Then run `/plugin install [name]`

### Repository Structure

```
psd-claude-coding-system/
  â”œâ”€â”€ .claude-plugin/
  â”‚   â””â”€â”€ marketplace.json    # CRITICAL - lists all plugins
  â”œâ”€â”€ plugins/
  â”‚   â””â”€â”€ psd-claude-coding-system/
  â”‚       â”œâ”€â”€ .claude-plugin/
  â”‚       â”‚   â””â”€â”€ plugin.json # Plugin metadata
  â”‚       â”œâ”€â”€ commands/       # 18 slash commands
  â”‚       â”œâ”€â”€ agents/         # 17 AI agents
  â”‚       â”œâ”€â”€ hooks/          # Hook configurations
  â”‚       â””â”€â”€ scripts/        # Hook scripts
  â”œâ”€â”€ README.md              # User-facing documentation
  â””â”€â”€ CLAUDE.md              # THIS FILE - AI guidance
```

## Development Commands

### Testing the Marketplace

```bash
# Install locally for testing
/plugin marketplace add ~/non-ic-code/psd-claude-coding-system
/plugin install psd-claude-coding-system
/plugin list

# Verify command availability
/work 1  # Test with dummy issue number

# Check telemetry hooks installed
ls ~/.claude/plugins/marketplaces/psd-claude-coding-system/plugins/psd-claude-coding-system/hooks/

# Uninstall for clean testing
/plugin uninstall psd-claude-coding-system
/plugin marketplace remove psd-claude-coding-system
```

### Publishing to GitHub

```bash
# This is a git repository
git status
git add .
git commit -m "Detailed message"
git push origin main

# Users install via GitHub
/plugin marketplace add psd401/psd-claude-coding-system
/plugin install psd-claude-coding-system
```

### Modifying Commands or Agents

1. Edit the relevant `.md` file in `plugins/[plugin]/commands/` or `plugins/[plugin]/agents/`
2. Frontmatter YAML controls behavior (model, tools, extended-thinking, color)
3. Test changes by reinstalling: `/plugin uninstall [name]` then `/plugin install [name]`
4. No build step required - Claude Code reads markdown directly

### Testing Individual Commands

```bash
# Commands can only be tested after plugin installation
/plugin install psd-claude-coding-system
/work "add logging to auth module"
/test auth
/compound_concepts
```

### Troubleshooting Plugin Installation

**Problem: "Plugin not found in any marketplace"**

This means marketplace.json doesn't list the plugin or points to wrong path.

**Solution:**
1. Verify marketplace.json lists the plugin:
   ```bash
   cat .claude-plugin/marketplace.json | jq '.plugins[].name'
   ```
2. Verify plugin directory exists:
   ```bash
   ls -la plugins/psd-claude-coding-system/.claude-plugin/
   ```
3. If mismatch, update marketplace.json and push
4. Force refresh:
   ```bash
   cd ~/.claude/plugins/marketplaces/psd-claude-coding-system
   git pull origin main
   ```
5. Retry install:
   ```bash
   /plugin install psd-claude-coding-system
   ```

**Problem: Old plugins still showing up**

Claude Code caches plugin metadata in `~/.claude/settings.json`.

**Solution (Nuclear Option):**
1. Exit Claude Code completely
2. Backup and remove cache:
   ```bash
   mv ~/.claude/plugins ~/.claude/plugins.backup
   ```
3. Restart Claude Code (recreates plugins/ directory)
4. Re-add marketplace:
   ```bash
   /plugin marketplace add psd401/psd-claude-coding-system
   /plugin install psd-claude-coding-system
   ```

**Problem: Plugin installs but commands don't work**

Check hooks are installed:
```bash
ls ~/.claude/plugins/marketplaces/psd-claude-coding-system/plugins/psd-claude-coding-system/hooks/
# Should show: hooks.json

ls ~/.claude/plugins/marketplaces/psd-claude-coding-system/plugins/psd-claude-coding-system/scripts/
# Should show: telemetry-*.sh files
```

## Compound Engineering Principles

This system embodies compound engineering - every interaction creates improvement opportunities:

- Every bug â†’ prevention system
- Every manual process â†’ automation candidate
- Every solution â†’ template for similar problems
- Every workflow â†’ data for meta-learning system

Use `/compound_concepts` after completing work to extract systematization opportunities.

## Important Notes

### Version Management

**CRITICAL**: Always bump version numbers when making changes to the plugin!

**Version bumping locations** (update ALL of these):
1. `plugins/psd-claude-coding-system/.claude-plugin/plugin.json` - `"version": "X.Y.Z"`
2. `.claude-plugin/marketplace.json` - `metadata.version` AND `plugins[0].version`
3. `CLAUDE.md` - Line 12: `**Version**: X.Y.Z`
4. `README.md` - Line 13: `**Version**: X.Y.Z` (2 instances, use replace_all)
5. `plugins/psd-claude-coding-system/README.md` - Line 5: `Version: X.Y.Z`

**Semantic versioning:**
- **Major (2.0.0)**: Breaking changes, incompatible API changes
- **Minor (1.2.0)**: New features, backward compatible
- **Patch (1.1.1)**: Bug fixes, backward compatible

**When to bump:**
- âœ… After fixing bugs (patch: 1.1.0 â†’ 1.1.1)
- âœ… After adding features (minor: 1.1.0 â†’ 1.2.0)
- âœ… After breaking changes (major: 1.1.0 â†’ 2.0.0)

**Example commit:**
```bash
git add [all 5 files above]
git commit -m "chore: Bump version to X.Y.Z ([reason])"
git push origin main
```

### Git Workflow
- Always branch from `dev`, not `main` (see `/work` command Phase 2)
- Branch naming: `feature/[issue-number]-brief-description` for issues, `fix/brief-description` for quick fixes
- Detailed commit messages required (per user's global CLAUDE.md)

### Telemetry & Privacy
- Meta-learning telemetry is **git-ignored by default** (in `meta/` folder)
- Only logs: command names, durations, success/failure, file counts
- Never logs: code content, issue details, personal data
- Collected automatically via hooks (v1.1.0+)
- Users can opt-out by disabling hooks or removing plugin

### Model Selection Strategy
- **sonnet-4-5**: Default for commands, agents, and coding tasks (fast + capable)
- **opus-4-1**: Architecture and product-manager commands only (deep reasoning)
- **extended-thinking: true**: Enabled on all commands/agents for thorough analysis

## Future Development

Documentation stubs exist in `docs/` but are not yet written:
- GETTING_STARTED.md
- WORKFLOW_PLUGIN.md
- META_LEARNING_SYSTEM.md
- ARCHITECTURE.md

External planning docs referenced in README exist on user's Desktop but are not in repository.
